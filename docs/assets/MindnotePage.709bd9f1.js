import{m as f,v as M,o as p,e as m,n as T,q as x,g as k,r as v,h as c,i as I,p as w,k as C,F as W,j as E,b as z,s as g,f as O}from"./vendor.a8b34c3e.js";import{_}from"./index.164c1c09.js";import{a as F,r as B,g as $,s as H}from"./util.9e521194.js";const j={name:"MindnoteInput",props:{value:Object},data(){return{isSelected:!1,message:this.value,styleObject:{width:"200px"}}},watch:{value:function(e,t){console.log("Prop changed: ",e," | was: ",t),this.message=this.value}},mounted(){this.checkWidth()},methods:{pressEnter:function(){console.log("input > pressEnter",this),this.$emit("hit-enter",this)},pressTab:function(){console.log("input > pressTab"),this.$emit("hit-tab",this)},pressDelete:function(){console.log("input > pressDelete"),this.value.name==""&&this.$emit("hit-delete",this)},hitInput:function(){console.log("hitInput"),this.checkWidth(),this.$emit("press-input",this.treeData)},checkWidth(){if(this.$refs&&this.$refs.inputElment){const e=6;let t=this.$refs.inputElment.offsetWidth;const i=this.$refs.inputElment.scrollWidth;i>t&&(t=i+e),window.innerWidth-t>50&&(this.styleObject.width=t+"px")}}}};function R(e,t,i,l,s,n){return f((p(),m("input",{class:T({isSelected:s.isSelected}),ref:"inputElment",autocomplete:"false",spellcheck:"false",onInput:t[0]||(t[0]=(...a)=>n.hitInput&&n.hitInput(...a)),onKeydown:[t[1]||(t[1]=x((...a)=>n.pressEnter&&n.pressEnter(...a),["enter"])),t[2]||(t[2]=x((...a)=>n.pressTab&&n.pressTab(...a),["tab"])),t[3]||(t[3]=x((...a)=>n.pressDelete&&n.pressDelete(...a),["delete"]))],"onUpdate:modelValue":t[4]||(t[4]=a=>s.message.name=a),style:k(s.styleObject)},null,38)),[[M,s.message.name]])}var q=_(j,[["render",R],["__scopeId","data-v-12a857bc"]]);const A={name:"MindnoteItem",components:{MindnoteInput:q},props:["item"],data(){return{isOpen:!0,value:this.item}},watch:{item:function(e,t){console.log("Prop changed: ",e," | was: ",t),this.value=this.item}},computed:{isFolder:function(){return this.value.children&&this.value.children.length}},methods:{toggle:function(){console.log("item > toggle"),this.isOpen=!this.isOpen},enterItem:function(e){console.log("item > enterItem",this,e),this.$emit("hit-enter",this)},tabItem:function(){console.log("item > tabItem"),this.$emit("hit-tab",this)},deleteItem:function(e){console.log("item > deleteItem",this,e),this.$emit("hit-delete",this)},inputContent:function(){console.log("item > inputContent",this),this.$emit("press-input")}}},U=e=>(w("data-v-2cf79249"),e=e(),C(),e),G={class:"line-item"},K=U(()=>c("div",{class:"dot"},null,-1)),J=[K];function Q(e,t,i,l,s,n){const a=v("mindnote-input");return p(),m("div",G,[c("div",{class:T(["bullet",{folder:!n.isFolder}]),onClick:t[0]||(t[0]=(...r)=>n.toggle&&n.toggle(...r))},J,2),I(a,{class:"line-content",value:s.value,onHitEnter:n.enterItem,onHitTab:n.tabItem,onHitDelete:n.deleteItem,onPressInput:n.inputContent,ref:"inputitem"},null,8,["value","onHitEnter","onHitTab","onHitDelete","onPressInput"])])}var V=_(A,[["render",Q],["__scopeId","data-v-2cf79249"]]);const X={props:["propsitem"],components:{MindnoteItem:V},data(){return{isOpen:!0,treeData:[{id:1,name:"Untitled"}]}},beforeMount(){this.propsitem&&this.propsitem.length?this.treeData=this.propsitem:this.treeData=[{id:1,name:"Untitled"}]},watch:{propsitem:function(e,t){console.log("Prop changed: ",e," | was: ",t),this.treeData=this.propsitem}},methods:{toggle(){console.log("child > toggle"),this.isOpen=!this.isOpen},enterItem(e){console.log("child > enterItem",this);const t=e._.vnode.key,i=e.$parent.treeData.length,l=t+1,s={id:i,name:"",remark:"",children:[]},n=e.$parent.treeData;if(n&&n.length>=1&&!n[l-1].name){e.$parent.$parent&&e.$parent.$parent.treeData&&(e.$parent.$parent.treeData.push(s),this.$emit("press-input"),this.$nextTick(()=>this.$el.parentElement.parentElement.nextElementSibling.querySelector("input").focus()));return}this.treeData.splice(l,0,s),this.$nextTick(()=>this.$el.children[l].querySelector("input").focus()),this.$emit("press-input")},addSubitem(){console.log("child > addSubitem",this.treeData),this.$emit("add-subitem",this.treeData),this.isOpen=!0},tabItem(e){console.log("child > tabItem",e);const t=e._.vnode.key;if(t){const i=e._.vnode.key-1,l=e.$parent.treeData[i];l.children||(l.children=[]),l.children.push(e.value),e.$parent.treeData.splice(t,1),this.$emit("press-input"),setTimeout(()=>{this.$el.querySelector(".mindnote-children").querySelector("input").focus()},100)}else console.log("child > tabItem > input > focus")},deleteItem(e){console.log("child > deleteItem",this.treeData);const t=e._.vnode.key;e.$parent.treeData.splice(t,1),this.$emit("delete-item"),this.$nextTick(()=>{setTimeout(()=>{let i=this.$el.parentElement.querySelectorAll(".line-item");i[i.length-1].querySelector("input").focus()},100)})},inputContent(){console.log("child > inputContent",this),this.$emit("press-input")}}},Y=e=>(w("data-v-00acb4b8"),e=e(),C(),e),Z={class:"mindnote"},N={key:0,class:"mindnote-children"},ee=Y(()=>c("div",{class:"mindnote-children__connection"},null,-1));function te(e,t,i,l,s,n){const a=v("mindnote-item"),r=v("mindnote",!0);return p(),m("div",Z,[(p(!0),m(W,null,E(s.treeData,(h,d)=>(p(),m("div",{key:d,ref_for:!0,ref:"treeData"},[(p(),z(a,{key:d,ref_for:!0,ref:"mindnoteTree",item:h,onHitEnter:n.enterItem,onHitTab:n.tabItem,onHitDelete:n.deleteItem,onPressInput:n.inputContent},null,8,["item","onHitEnter","onHitTab","onHitDelete","onPressInput"])),h.children&&h.children.length?f((p(),m("div",N,[ee,I(r,{propsitem:h.children,onPressInput:n.inputContent,onAddSubitem:n.inputContent},null,8,["propsitem","onPressInput","onAddSubitem"])],512)),[[g,s.isOpen]]):O("",!0)]))),128))])}var ie=_(X,[["render",te],["__scopeId","data-v-00acb4b8"]]);var o={textFilter:{label:"Text Filter (regex)",type:"text",val:"."},fontSize:{label:"Font size",model:"fontSize",min:5,max:50,val:13},connectorWidth:{label:"Connector width",model:"connectorWidth",min:20,max:100,val:65},connectorSteepness:{label:"Connector steepness",min:.1,max:1,step:.01,val:.65},connectorLineWidth:{label:"Line width",min:.5,max:10,step:.25,val:4.5},nodeMarginTop:{label:" Top margin",min:0,max:50,val:5},nodeMarginBottom:{label:" Bottom margin",min:0,max:50,val:5},useGrayscale:{label:"Use grayscale",type:"boolean",val:0}},y="Open Sans",S=8,D=10;class P{constructor(t,i=!1){this.label=t,this.labelLines=this.label.split(`
`),this.isRoot=i,this.parent=void 0,this.children=[]}get isLeaf(){return this.children.length==0}addChild(t){t.parent=this,this.children.push(t)}addChildren(...t){for(var i of t)this.addChild(i)}draw(t){if(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.ctx.font=o.fontSize.val+"px "+y,this.textHeight=o.fontSize.val*this.labelLines.length,this.composedHeight=this.textHeight+S+o.connectorLineWidth.val,this.paddedHeight=this.composedHeight+o.nodeMarginTop.val,this.labelHeight=o.nodeMarginTop.val+o.fontSize.val*(this.labelLines.length+1)+o.nodeMarginBottom.val,this.labelWidth=Math.ceil(Math.max(...this.labelLines.map(d=>this.ctx.measureText(d).width))),this.isLeaf){this.canvas.width=this.labelWidth+D*2,this.canvas.height=this.labelHeight,this.ctx.font=o.fontSize.val+"px "+y;for(var i=0;i<this.labelLines.length;i++)this.ctx.fillText(this.labelLines[i],0,o.fontSize.val*(i+1)+o.nodeMarginTop.val);this.anchorPoint={x:0,y:this.labelLines.length*o.fontSize.val+S+o.nodeMarginTop.val}}else{if(this.isRoot)var l=this.children.map(u=>F(o.useGrayscale)),s=this.children.map((u,b)=>u.draw(l[b]));else var s=this.children.map((b,pe)=>b.draw(t));for(var n=[0],i=0;i<s.length;i++)n[i+1]=n[i]+s[i].height;let d=n[s.length];this.anchorPoint={x:this.isRoot?10:0,y:0},d<this.composedHeight+o.nodeMarginTop.val*2?(this.canvas.height=this.composedHeight+o.nodeMarginTop.val*2,this.anchorPoint.y=this.canvas.height/2+this.composedHeight/2):(this.canvas.height=Math.max(n[s.length],this.composedHeight*2),this.anchorPoint.y=this.canvas.height/2),console.log(this.label,this.canvas.height,n[s.length]);var a=10+this.labelWidth+o.connectorWidth.val;this.canvas.width=a+Math.max(...s.map(u=>u.width)),this.ctx.font=o.fontSize.val+"px "+y;for(var i=0;i<s.length;i++){this.isRoot&&(t=l[i]),this.ctx.drawImage(s[i],a,n[i]);var r={x:this.anchorPoint.x+this.labelWidth+D,y:this.anchorPoint.y},h={x:a,y:n[i]+this.children[i].anchorPoint.y};this.ctx.beginPath(),this.ctx.moveTo(r.x,r.y),this.ctx.bezierCurveTo(r.x+o.connectorSteepness.val*o.connectorWidth.val,r.y,h.x-o.connectorSteepness.val*o.connectorWidth.val,h.y,h.x,h.y),this.ctx.lineTo(h.x+this.children[i].labelWidth+D,h.y),this.ctx.lineWidth=o.connectorLineWidth.val,this.ctx.lineCap="round",this.ctx.strokeStyle=t,this.ctx.stroke()}if(this.isRoot){this.ctx.fillStyle="#ffffff",this.ctx.lineWidth=3,B(this.ctx,2,this.canvas.height/2-this.labelLines.length*o.fontSize.val,this.labelWidth+18,o.fontSize.val*(this.labelLines.length+1.5),5,!0,!0),this.ctx.fillStyle="#000000";for(var i=0;i<this.labelLines.length;i++)this.ctx.fillText(this.labelLines[i],10,this.canvas.height/2+o.fontSize.val/2-o.fontSize.val*(this.labelLines.length-i-1))}else{this.ctx.fillStyle="#000000";for(var i=0;i<this.labelLines.length;i++)this.ctx.fillText(this.labelLines[i],10,this.anchorPoint.y-S-o.fontSize.val*(this.labelLines.length-i-1))}}return this.canvas}}function ne(e){var t={label:"ROOT",children:[],depth:-1},i=e.split(`
`);i=i.filter(u=>!u.match(/^\s*$/));var l=t,s=-1,n="",a;for(var r of i){var h=r.match(/^( *)-\s*(.*)$/);if(h){if(n!=""){var d={label:n,children:[],parent:l,depth:a};l.children.push(d),l=d,s=d.depth}for(a=h[1].length,n=h[2];a<=s;)l=l.parent,s=l.depth}else n+=`
`+r}if(n){var d={label:n,children:[],parent:l,depth:s+1};l.children.push(d)}return t}function L(e){this.el=e.el,this.currentTree=void 0,this.treeProperties={},this.sourceCode=e.sourceCode;for(var t in o)this.treeProperties[t]=o[t].val;this.parseSource()}L.prototype={parseSource:function(){console.log("Parsing...");try{console.log(222),console.log(this.sourceCode);var e=ne(this.sourceCode);console.log(e)}catch{console.log("Error sourceCode parse fail");return}if(e.children.length!=0){e=e.children[0];try{o.textFilter.val!=""?this.textFilter=new RegExp(o.textFilter.val):this.textFilter=new RegExp(".+")}catch(t){console.log(t);return}this.currentTree=this.parseObjectBranch(e,!0),this.regenerateDiagram()}},parseObjectBranch:function(e,t=!1){var i=new P(e.label,t);for(var l of e.children)this.textFilter.test(l.label)&&i.addChild(this.parseObjectBranch(l,!1));return i},regenerateDiagram:function(){var e=this.el,t=e.getContext("2d");if(!(this.currentTree instanceof P)){console.log("Not a valid tree",this.currentTree);return}var i=this.currentTree.draw();e.width=i.width+25,e.height=i.height+25,t.drawImage(i,25,25)},buildGlobalProperties:function(){for(var e in o)e!="textFilter"?o[e].val=Number(this.treeProperties[e]):o[e].val=this.treeProperties[e];this.parseSource()}};const se={name:"MindnotePage",components:{Mindnote:ie},data(){return{isHideMindmap:!0,title:this.getDefaultTitle(),listItemData:[],rootItem:{name:"Untitled"}}},created(){this.getData(),this.$nextTick(()=>this.$refs.title.focus())},methods:{viewMindmap(){this.isHideMindmap=!1;let e=this.buildSourceCode(this.listItemData,["- "+this.title],{depth:0}).join(`
`);new L({el:this.$refs.mindmap,sourceCode:e})},buildSourceCode(e,t,i={}){let l=[];return e instanceof Array,l.push(e),l&&l.forEach(s=>{s.forEach(n=>{let a="";if(i.depth>=0)for(let r=0;r<=i.depth;r++)a="  "+a;t.push(a+`- ${n.name}`),n.children&&n.children.length&&this.buildSourceCode(n.children,t,{depth:i.depth+1})})}),t},getData(){const e=$(this.getMindnoteId());this.listItemData=e},saveMindnote(){console.log("saveMindnote",this.listItemData),H(this.getMindnoteId(),this.listItemData)},getMindnoteId(){return this.$route.params.mindnoteId},getDefaultTitle(){let e=this.fetchMindnoteById(this.getMindnoteId());return e?e.name:""},fetchMindnoteById(e){return this.fetchLocalDb().find(t=>t.id==e)},fetchLocalDb(){return $("mindnoteItems")},onTitleChange(){let e=this.fetchLocalDb(),t=this.fetchMindnoteById(this.getMindnoteId()),i=e.findIndex(l=>l.id==t.id);t&&(t.name=this.title,e[i]=t,H("mindnoteItems",e))}},mounted(){}},le={class:"pape-mindnote"},oe={class:"pape-mindnote__bd"},ae={class:"pape-mindnote__bd__title"},re={class:"pape-mindnote__bd__tree"},he={class:"page-mindnote__mindmap"},de={ref:"mindmap"};function ce(e,t,i,l,s,n){const a=v("mindnote");return p(),m("div",le,[c("div",oe,[f(c("a",{class:"btn-view-mindmap",onClick:t[0]||(t[0]=(...r)=>n.viewMindmap&&n.viewMindmap(...r))},"\u67E5\u770B\u5173\u7CFB\u56FE",512),[[g,s.isHideMindmap]]),f(c("a",{class:"btn-view-mindmap",onClick:t[1]||(t[1]=r=>s.isHideMindmap=!0)},"\u5173\u95ED",512),[[g,!s.isHideMindmap]]),c("div",ae,[f(c("input",{type:"text",placeholder:"\u65E0\u6807\u9898","onUpdate:modelValue":t[2]||(t[2]=r=>s.title=r),onChange:t[3]||(t[3]=(...r)=>n.onTitleChange&&n.onTitleChange(...r)),ref:"title",class:"input-title"},null,544),[[M,s.title]])]),c("div",re,[I(a,{class:"mindnote",ref:"mindnote",propsitem:s.listItemData,onPressInput:n.saveMindnote,onAddSubitem:n.saveMindnote,onDeleteItem:n.saveMindnote},null,8,["propsitem","onPressInput","onAddSubitem","onDeleteItem"])]),f(c("div",he,[c("canvas",de,null,512)],512),[[g,!s.isHideMindmap]])])])}var ve=_(se,[["render",ce],["__scopeId","data-v-b39373c6"]]);export{ve as default};
